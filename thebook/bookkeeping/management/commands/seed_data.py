import datetime
from decimal import Decimal

from django.contrib.auth import get_user_model
from django.core.management.base import BaseCommand
from django.db import models, transaction

from thebook.bookkeeping.models import (
    CashBook,
    Category,
    CategoryMatchRule,
    Transaction,
)
from thebook.members.models import (
    FeeIntervals,
    FeePaymentStatus,
    Member,
    Membership,
    PaymentMethod,
    ReceivableFee,
)

User = get_user_model()

# Livros de Caixa
CASH_BOOKS_DATA = [
    {
        "name": "Conta Corrente Principal",
        "description": "Conta principal do hackerspace - Nubank",
        "slug": "conta-principal",
        "active": True,
    },
    {
        "name": "Poupan√ßa LHC",
        "description": "Reserva para emerg√™ncias",
        "slug": "poupanca",
        "active": True,
    },
]

# Membros
MEMBERS_DATA = [
    {
        "name": "Ana Carolina Silva",
        "email": "ana.silva@lhc.net.br",
        "phone": "(19) 99911-2233",
        "has_key": True,
        "start_date": "2023-06-01",
    },
    {
        "name": "Bruno Oliveira Santos",
        "email": "bruno.santos@lhc.net.br",
        "phone": "(19) 99922-3344",
        "has_key": True,
        "start_date": "2023-07-15",
    },
    {
        "name": "Carlos Eduardo Lima",
        "email": "carlos.lima@lhc.net.br",
        "phone": "(19) 99933-4455",
        "has_key": False,
        "start_date": "2023-08-01",
    },
    {
        "name": "Daniela Rodrigues",
        "email": "daniela.rodrigues@lhc.net.br",
        "phone": "(19) 99944-5566",
        "has_key": True,
        "start_date": "2023-09-10",
    },
    {
        "name": "Eduardo Ferreira Costa",
        "email": "eduardo.costa@lhc.net.br",
        "phone": "(19) 99955-6677",
        "has_key": False,
        "start_date": "2023-10-05",
    },
    {
        "name": "Fernanda Alves",
        "email": "fernanda.alves@lhc.net.br",
        "phone": "(19) 99966-7788",
        "has_key": True,
        "start_date": "2023-11-20",
    },
    {
        "name": "Gabriel Martins",
        "email": "gabriel.martins@lhc.net.br",
        "phone": "(19) 99977-8899",
        "has_key": False,
        "start_date": "2024-01-01",
    },
    {
        "name": "Helena Pereira",
        "email": "helena.pereira@lhc.net.br",
        "phone": "(19) 99988-9900",
        "has_key": True,
        "start_date": "2024-01-15",
    },
]

# Regras de Categoriza√ß√£o
CATEGORIZATION_RULES = [
    {
        "priority": 1,
        "pattern": r".*mensalidade.*|.*contribui√ß√£o.*",
        "category": "Contribui√ß√£o Associativa",
        "tags": "mensalidade,membro",
    },
    {
        "priority": 2,
        "pattern": r".*pix.*|.*transfer√™ncia.*",
        "category": "Transfer√™ncia entre livros-caixa",
        "tags": "pix,transferencia",
    },
    {
        "priority": 3,
        "pattern": r".*tarifa.*|.*taxa.*",
        "category": "Tarifas Banc√°rias",
        "tags": "banco,tarifa",
    },
    {
        "priority": 4,
        "pattern": r".*aluguel.*|.*rent.*",
        "category": "Recorrente",
        "tags": "aluguel,recorrente",
    },
    {
        "priority": 5,
        "pattern": r".*energia.*|.*luz.*",
        "category": "Recorrente",
        "tags": "energia,recorrente",
    },
    {
        "priority": 6,
        "pattern": r".*internet.*|.*fibra.*",
        "category": "Recorrente",
        "tags": "internet,recorrente",
    },
    {
        "priority": 7,
        "pattern": r".*√°gua.*|.*agua.*",
        "category": "Recorrente",
        "tags": "agua,recorrente",
    },
    {
        "priority": 8,
        "pattern": r".*manuten√ß√£o.*|.*manutencao.*",
        "category": "Recorrente",
        "tags": "manutencao,equipamentos",
    },
]

# Transa√ß√µes de Janeiro 2024
JANUARY_TRANSACTIONS = [
    # MENSALIDADES
    {
        "date": "2024-01-05",
        "description": "PIX - Mensalidade Ana Carolina Silva",
        "amount": 89.00,
    },
    {
        "date": "2024-01-07",
        "description": "PIX - Mensalidade Bruno Oliveira Santos",
        "amount": 89.00,
    },
    {
        "date": "2024-01-10",
        "description": "PIX - Mensalidade Carlos Eduardo Lima",
        "amount": 89.00,
    },
    {
        "date": "2024-01-12",
        "description": "PIX - Mensalidade Daniela Rodrigues",
        "amount": 89.00,
    },
    {
        "date": "2024-01-15",
        "description": "PIX - Mensalidade Eduardo Ferreira Costa",
        "amount": 89.00,
    },
    {
        "date": "2024-01-18",
        "description": "PIX - Mensalidade Fernanda Alves",
        "amount": 89.00,
    },
    {
        "date": "2024-01-20",
        "description": "PIX - Mensalidade Gabriel Martins",
        "amount": 89.00,
    },
    {
        "date": "2024-01-22",
        "description": "PIX - Mensalidade Helena Pereira",
        "amount": 89.00,
    },
    # DOA√á√ïES
    {
        "date": "2024-01-08",
        "description": "PIX - Doa√ß√£o para equipamentos",
        "amount": 150.00,
    },
    {"date": "2024-01-14", "description": "PIX - Doa√ß√£o an√¥nima", "amount": 50.00},
    {
        "date": "2024-01-25",
        "description": "PIX - Doa√ß√£o para eventos",
        "amount": 200.00,
    },
    {"date": "2024-01-28", "description": "Dinheiro - Doa√ß√£o caixa", "amount": 25.00},
    # GASTOS
    {
        "date": "2024-01-03",
        "description": "D√©bito - Aluguel do espa√ßo",
        "amount": -1200.00,
    },
    {
        "date": "2024-01-05",
        "description": "D√©bito - Energia el√©trica",
        "amount": -180.50,
    },
    {
        "date": "2024-01-08",
        "description": "D√©bito - Internet fibra √≥tica",
        "amount": -89.90,
    },
    {"date": "2024-01-10", "description": "D√©bito - √Ågua", "amount": -45.20},
    {
        "date": "2024-01-12",
        "description": "D√©bito - Material de limpeza",
        "amount": -67.80,
    },
    {"date": "2024-01-15", "description": "D√©bito - Tarifa banc√°ria", "amount": -12.50},
    {
        "date": "2024-01-18",
        "description": "D√©bito - Manuten√ß√£o equipamentos",
        "amount": -320.00,
    },
    {
        "date": "2024-01-22",
        "description": "D√©bito - Coffee break evento",
        "amount": -156.40,
    },
    {
        "date": "2024-01-25",
        "description": "D√©bito - Material para workshops",
        "amount": -89.90,
    },
    {
        "date": "2024-01-28",
        "description": "D√©bito - Taxa de processamento",
        "amount": -8.90,
    },
]

# Transa√ß√µes de Fevereiro 2024
FEBRUARY_TRANSACTIONS = [
    # MENSALIDADES
    {
        "date": "2024-02-05",
        "description": "PIX - Mensalidade Ana Carolina Silva",
        "amount": 89.00,
    },
    {
        "date": "2024-02-07",
        "description": "PIX - Mensalidade Bruno Oliveira Santos",
        "amount": 89.00,
    },
    {
        "date": "2024-02-10",
        "description": "PIX - Mensalidade Carlos Eduardo Lima",
        "amount": 89.00,
    },
    {
        "date": "2024-02-12",
        "description": "PIX - Mensalidade Daniela Rodrigues",
        "amount": 89.00,
    },
    {
        "date": "2024-02-15",
        "description": "PIX - Mensalidade Eduardo Ferreira Costa",
        "amount": 89.00,
    },
    {
        "date": "2024-02-18",
        "description": "PIX - Mensalidade Fernanda Alves",
        "amount": 89.00,
    },
    {
        "date": "2024-02-20",
        "description": "PIX - Mensalidade Gabriel Martins",
        "amount": 89.00,
    },
    {
        "date": "2024-02-22",
        "description": "PIX - Mensalidade Helena Pereira",
        "amount": 89.00,
    },
    # DOA√á√ïES
    {
        "date": "2024-02-02",
        "description": "PIX - Doa√ß√£o para melhorias",
        "amount": 100.00,
    },
    {
        "date": "2024-02-14",
        "description": "PIX - Doa√ß√£o dia dos namorados",
        "amount": 75.00,
    },
    {"date": "2024-02-20", "description": "PIX - Doa√ß√£o an√¥nima", "amount": 120.00},
    {"date": "2024-02-25", "description": "Dinheiro - Doa√ß√£o caixa", "amount": 30.00},
    # GASTOS
    {
        "date": "2024-02-03",
        "description": "D√©bito - Aluguel do espa√ßo",
        "amount": -1200.00,
    },
    {
        "date": "2024-02-05",
        "description": "D√©bito - Energia el√©trica",
        "amount": -195.30,
    },
    {
        "date": "2024-02-08",
        "description": "D√©bito - Internet fibra √≥tica",
        "amount": -89.90,
    },
    {"date": "2024-02-10", "description": "D√©bito - √Ågua", "amount": -52.10},
    {
        "date": "2024-02-12",
        "description": "D√©bito - Material de escrit√≥rio",
        "amount": -134.50,
    },
    {"date": "2024-02-15", "description": "D√©bito - Tarifa banc√°ria", "amount": -12.50},
    {
        "date": "2024-02-18",
        "description": "D√©bito - Seguro do espa√ßo",
        "amount": -89.90,
    },
    {
        "date": "2024-02-22",
        "description": "D√©bito - Lanches para reuni√£o",
        "amount": -87.60,
    },
    {
        "date": "2024-02-25",
        "description": "D√©bito - Manuten√ß√£o preventiva",
        "amount": -245.80,
    },
]


class Command(BaseCommand):
    help = "Cria dados iniciais completos para o sistema The Book - 2 meses de dados, 8 membros, R$89 mensais"

    def handle(self, *args, **options):
        self.stdout.write(
            self.style.SUCCESS("üöÄ Iniciando seed completo do sistema The Book...")
        )

        with transaction.atomic():
            # Reset completo
            self.reset_all_data()

            # Criar dados b√°sicos
            self.create_cash_books()
            self.create_categorization_rules()

            # Criar membros e mensalidades
            self.create_members_and_memberships()

            # Criar transa√ß√µes
            self.create_transactions()

            # Categorizar transa√ß√µes automaticamente
            self.categorize_transactions()

            # Criar taxas a receber
            self.create_receivable_fees()

        self.stdout.write(self.style.SUCCESS("‚úÖ Seed completo executado com sucesso!"))
        self.print_summary()

    def reset_all_data(self):
        """Remove todos os dados existentes"""
        self.stdout.write("üßπ Limpando dados existentes...")

        # Remover em ordem para evitar problemas de foreign key
        ReceivableFee.objects.all().delete()
        Membership.objects.all().delete()
        Member.objects.all().delete()
        Transaction.objects.all().delete()
        CategoryMatchRule.objects.all().delete()
        CashBook.objects.all().delete()

        self.stdout.write("‚úÖ Dados limpos com sucesso")

    def create_cash_books(self):
        """Cria livros de caixa"""
        self.stdout.write("üè¶ Criando livros de caixa...")

        for cash_book_data in CASH_BOOKS_DATA:
            cash_book = CashBook.objects.create(**cash_book_data)
            self.stdout.write(f"  ‚úÖ {cash_book.name}")

    def create_categorization_rules(self):
        """Cria regras de categoriza√ß√£o"""
        self.stdout.write("üè∑Ô∏è Criando regras de categoriza√ß√£o...")

        for rule_data in CATEGORIZATION_RULES:
            category, _ = Category.objects.get_or_create(name=rule_data["category"])

            CategoryMatchRule.objects.create(
                priority=rule_data["priority"],
                pattern=rule_data["pattern"],
                category=category,
                tags=rule_data.get("tags", ""),
            )
            self.stdout.write(f"  ‚úÖ Regra: {rule_data['pattern']} -> {category.name}")

    def create_members_and_memberships(self):
        """Cria membros e suas mensalidades"""
        self.stdout.write("üë• Criando membros e mensalidades...")

        for member_data in MEMBERS_DATA:
            # Criar usu√°rio
            user, created = User.objects.get_or_create(
                email=member_data["email"],
                defaults={
                    "first_name": member_data["name"].split()[0],
                    "last_name": " ".join(member_data["name"].split()[1:]),
                    "is_active": True,
                    "is_staff": False,
                },
            )

            # Definir senha padr√£o se o usu√°rio foi criado
            if created:
                user.set_password("tijolo22")  # Senha padr√£o para desenvolvimento
                user.save()

            # Criar membro
            member = Member.objects.create(
                name=member_data["name"],
                phone_number=member_data["phone"],
                has_key=member_data["has_key"],
                user=user,
            )

            # Criar mensalidade
            start_date = datetime.datetime.strptime(
                member_data["start_date"], "%Y-%m-%d"
            ).date()
            membership = Membership.objects.create(
                member=member,
                start_date=start_date,
                membership_fee_amount=Decimal("89.00"),
                payment_interval=FeeIntervals.MONTHLY,
                payment_method=PaymentMethod.PIX,
                active=True,
            )

            self.stdout.write(f"  ‚úÖ {member.name} - R$ 89,00/m√™s")

    def create_transactions(self):
        """Cria todas as transa√ß√µes"""
        self.stdout.write("üí∞ Criando transa√ß√µes...")

        # Buscar usu√°rio admin (primeiro usu√°rio criado)
        admin_user = User.objects.first()
        if not admin_user:
            admin_user = User.objects.create_user(
                email="admin@lhc.net.br",
                first_name="Admin",
                last_name="LHC",
                password="tijolo22",
                is_staff=True,
            )

        # Buscar livro de caixa principal
        main_cash_book = CashBook.objects.get(slug="conta-principal")

        # Combinar todas as transa√ß√µes
        all_transactions = JANUARY_TRANSACTIONS + FEBRUARY_TRANSACTIONS

        for transaction_data in all_transactions:
            transaction_date = datetime.datetime.strptime(
                transaction_data["date"], "%Y-%m-%d"
            ).date()
            Transaction.objects.create(
                reference=f"SEED-{transaction_data['date']}-{hash(transaction_data['description']) % 10000}",
                date=transaction_date,
                description=transaction_data["description"],
                amount=Decimal(str(transaction_data["amount"])),
                cash_book=main_cash_book,
                created_by=admin_user,
            )

        self.stdout.write(f"  ‚úÖ {len(all_transactions)} transa√ß√µes criadas")

    def categorize_transactions(self):
        """Aplica categoriza√ß√£o autom√°tica"""
        self.stdout.write("üè∑Ô∏è Aplicando categoriza√ß√£o autom√°tica...")

        rules = CategoryMatchRule.objects.order_by("priority")
        uncategorized_count = 0

        for transaction in Transaction.objects.all():
            transaction.categorize(rules=rules)
            if not transaction.category:
                uncategorized_count += 1

        self.stdout.write(
            f"  ‚úÖ Categoriza√ß√£o aplicada ({uncategorized_count} n√£o categorizadas)"
        )

    def create_receivable_fees(self):
        """Associa transa√ß√µes existentes com taxas a receber"""
        self.stdout.write("üìÖ Associando transa√ß√µes com taxas a receber...")

        associated_count = 0

        for membership in Membership.objects.filter(active=True):
            # Buscar transa√ß√µes de mensalidade para este membro
            member_first_name = membership.member.name.split()[0]

            # Transa√ß√µes de janeiro
            jan_transactions = Transaction.objects.filter(
                description__icontains=member_first_name,
                date__year=2024,
                date__month=1,
                amount=Decimal("89.00"),
            )

            # Transa√ß√µes de fevereiro
            feb_transactions = Transaction.objects.filter(
                description__icontains=member_first_name,
                date__year=2024,
                date__month=2,
                amount=Decimal("89.00"),
            )

            # Associar transa√ß√µes com taxas a receber correspondentes
            for transaction in jan_transactions:
                # Buscar taxa a receber que corresponde a esta transa√ß√£o
                receivable_fee = ReceivableFee.objects.filter(
                    membership=membership,
                    start_date__year=2024,
                    start_date__month=1,
                    status=FeePaymentStatus.UNPAID,
                ).first()

                if receivable_fee and not receivable_fee.transaction:
                    receivable_fee.paid_with(transaction)
                    associated_count += 1

            for transaction in feb_transactions:
                # Buscar taxa a receber que corresponde a esta transa√ß√£o
                receivable_fee = ReceivableFee.objects.filter(
                    membership=membership,
                    start_date__year=2024,
                    start_date__month=2,
                    status=FeePaymentStatus.UNPAID,
                ).first()

                if receivable_fee and not receivable_fee.transaction:
                    receivable_fee.paid_with(transaction)
                    associated_count += 1

        self.stdout.write(
            f"  ‚úÖ {associated_count} transa√ß√µes associadas com taxas a receber"
        )

    def print_summary(self):
        """Imprime resumo dos dados criados"""
        self.stdout.write("\n" + "=" * 50)
        self.stdout.write(self.style.SUCCESS("üìä RESUMO DO SEED:"))
        self.stdout.write("=" * 50)
        self.stdout.write(f"üè¶ Livros de Caixa: {CashBook.objects.count()}")
        self.stdout.write(f"üë• Membros: {Member.objects.count()}")
        self.stdout.write(f"üí∞ Transa√ß√µes: {Transaction.objects.count()}")
        self.stdout.write(f"üè∑Ô∏è Categorias: {Category.objects.count()}")
        self.stdout.write(
            f"üìã Regras de Categoriza√ß√£o: {CategoryMatchRule.objects.count()}"
        )
        self.stdout.write(f"üìÖ Taxas a Receber: {ReceivableFee.objects.count()}")
        self.stdout.write(f"üë§ Usu√°rios: {User.objects.count()}")

        # Resumo financeiro
        total_deposits = Transaction.objects.filter(amount__gt=0).aggregate(
            total=models.Sum("amount")
        )["total"] or Decimal("0")

        total_withdraws = Transaction.objects.filter(amount__lt=0).aggregate(
            total=models.Sum("amount")
        )["total"] or Decimal("0")

        balance = total_deposits + total_withdraws

        self.stdout.write("\nüí∞ RESUMO FINANCEIRO:")
        self.stdout.write(f"  üìà Total Dep√≥sitos: R$ {total_deposits:,.2f}")
        self.stdout.write(f"  üìâ Total Saques: R$ {total_withdraws:,.2f}")
        self.stdout.write(f"  üí∞ Saldo Total: R$ {balance:,.2f}")

        self.stdout.write("\nüöÄ Sistema pronto para uso!")
        self.stdout.write("   Acesse: http://127.0.0.1:8000")
        self.stdout.write("   Admin: http://127.0.0.1:8000/admin")

        self.stdout.write("\nüîë CREDENCIAIS DE ACESSO:")
        self.stdout.write("   Senha padr√£o para todos: tijolo22")
        self.stdout.write("   üëë ADMINISTRADOR:")
        self.stdout.write("     ‚Ä¢ admin@lhc.net.br (superuser)")
        self.stdout.write("   üë• MEMBROS:")
        for member in Member.objects.all():
            self.stdout.write(f"     ‚Ä¢ {member.name}: {member.user.email}")
